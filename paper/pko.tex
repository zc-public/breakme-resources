\begin{tikzpicture}[
    box/.style={draw, thick, minimum width=1.2cm, minimum height=0.7cm, anchor=west},
    reg/.style={minimum height=0.7cm, minimum width=0.7*4cm, anchor=west},
    arr/.style={thick,->,>=Stealth},
    lab/.style={anchor=east, font=\bfseries\large},
    subword/.style={draw, thick, minimum height=0.7cm, minimum width=0.7cm, fill=white},
    subwordred/.style={draw, thick, minimum height=0.7cm, minimum width=0.7cm, fill=red!50},
    subwordredhoriz/.style={inner sep=0pt, outer sep=0pt, text height=0.176cm, minimum width=2.8cm, fill=red!50, draw=none},
    subwordgreen/.style={draw, thick, minimum height=0.7cm, minimum width=0.7cm, fill=green!50},
    subwordgreenhoriz/.style={inner sep=0pt, outer sep=0pt, text height=0.176cm, minimum width=2.8cm, fill=green!50, draw=none},
    cyclab/.style={font=\scriptsize, inner sep=1pt}
]

% Phase 1
\foreach \i in {0,1,2,3} {
    \node[lab] (K\i) at (0,-\i*1.3) {$K_{\i}$};
}
\node at (1.55,0.65) [font=\small] {key register};
\node at (1.55+1+0.7*4,0.65) [font=\small] {ciphertext output};

% Key register boxes (phase 1)
\foreach \i in {0,1,2,3} {
    \node[reg] (KR\i) at (0.14,-\i*1.3) {};
    \foreach \j in {0,1,2,3} {
        \ifnum\j<\i
            \node[subwordred] at (0.5+0.7*\j,-\i*1.3) {0};
        \else
            \node[subword] at (0.5+0.7*\j,-\i*1.3) {};
        \fi
    }
}

\foreach \i in {1,2,3} {
            \node[subwordredhoriz, text height=0.175cm*\i] at (5.38,0.35-\i*1.385) {};
}
% Arrow to ciphertext (A)
\foreach \i in {0,1,2,3} {
    \draw[arr] (KR\i.east) -- ++(1,0) node[midway, above=0pt, cyclab] {(\the\numexpr\i*2+1\relax)} node[reg, draw] (C\i) {$C_{\i}$};
}

% Arrow to next register step (B)
\foreach \i in {1,2,3} {
    \draw[
      thick, bend right=45,
      -{Stealth}] (KR\the\numexpr\i-1\relax.west) to node[cyclab, left=0.07cm] {(\the\numexpr\i*2\relax)} (KR\i.west);
  }

% Phase 2 (to the right)
\foreach \i in {0,1,2,3} {
    \node[lab] (K2\i) at (9.14,-\i*1.3) {$K_{\i}$};
}
\node[] at (1.55+9.14,0.65) [font=\small] {key register};
\node at (1.55+1+0.7*4+9.14,0.65) [font=\small] {ciphertext output};

\foreach \i in {0,1,2,3} {
    \node[reg] (K2R\i) at (0.15+9.14,-\i*1.3) {};
    \foreach \j in {0,1,2,3} {
        \ifnum\j<\i
            \node[subwordred] at (0.5+0.7*\j+9.14,-\i*1.3) {0};
        \else
            \node[subwordgreen] at (0.5+0.7*\j+9.14,-\i*1.3) {};
        \fi
    }
}

\foreach \i in {0,1,2,3} {
    \node[subwordgreenhoriz, text height=0.7cm] at (5.38+9.14,-\i*1.3) {};
}
\foreach \i in {1,2,3} {
    \node[subwordredhoriz, text height=0.175cm*\i] at (5.38+9.14,0.35-\i*1.385) {};
}
% Arrow to key register (C)
\foreach \i in {0,1,2,3} {
    \draw[arr, <-] (K2R\i.east) -- ++(1,0) node[midway, above=0pt, cyclab] {(\the\numexpr14-\i*2\relax)} node[reg, draw] (C\i) {$C_{\i}$};
  }

% Arrow to prev register step D)
\foreach \i in {1,2,3} {
    % \draw[
    %   thick, bend right=45, <-,
    %   >={Stealth}] (K2R\the\numexpr\i-1\relax.west) to node[cyclab, left=0.07cm] {(\the\numexpr15-\i*2\relax)} (K2R\i.west);
    \draw[
      thick, bend right=-45, <-,
      >={Stealth}] ($(K2R\the\numexpr\i-1\relax.east) + (3.82cm,0)$) to node[cyclab, right=0.07cm] {(\the\numexpr15-\i*2\relax)} ($(K2R\i.east)+ (3.82cm,0)$);
}
\node at (3.5,-4.8) [font=\small] {Online phase};
\node at (3.5+9.14,-4.8) [font=\small] {Offline phase};

\end{tikzpicture}
